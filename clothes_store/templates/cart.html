{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="cart-container">
    <h1 class="cart-head">Shopping Cart</h1>
    <div class="cart-items">
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <p>You must fill out personal information before proceeding to payment</p>
                <button id="goToPageButton" class="my-button">Ok</button>
            </div>
        </div>
        <div id="myModal1" class="modal-1">
            <div class="modal-content-1">
                <span class="close-1">&times;</span>
                <p>You have to add some items in your cart</p>
                <button id="goToPageButton-1" class="my-button">Ok</button>
            </div>
        </div>
        {% for product in products %}
        <div class="cart-item">
            <a href="/product/{{product.product_id.product.id}}">
                <img src="{{product.product_id.product.image.url}}" alt="">
            </a>
            <div class="item-details">
                <p class="price">Price: ${{product.product_id.product.price}}</p>
                <p class="size">Size: {{product.product_id.size}}</p>
                <p class="quantity">Quantity: {{product.quantity}}</p>
            </div>
            <button class="remove-btn" data-product-id="{{product.product_id.product.id}}">Remove</button>
        </div>
        {% endfor %}
    </div>
    <div class="cart-summary">
        <h3>Cart Summary</h3>
        <p class="total-items">Total Items: {{total_items}}</p>
        <p class="total-price">Total Price: ${{total_price}}</p>
        <button class="checkout-btn" user-profile-id="{{user_profile.id_user}}">Checkout</button>
    </div>
</div>
    {% block subscribe %}
    {% endblock %}
{% endblock %}

{% block custom_css %}
<style>
.cart-container {
    max-width: 800px;
    margin: 200px auto;
    padding: 20px;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

h1, h2, h3 {
    color: #333;
}
.cart-head{
    margin-bottom: 30px;

}

.cart-item {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding: 10px;
    background-color: #f9f9f9;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding-left: 30px;
}

.cart-item img {
    width: 80px;
    height: auto;
    margin-right: 10px;
}

.item-details {
    flex: 1;
}

.remove-btn {
    background-color: #e74c3c;
    color: #fff;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
}

.cart-summary {
    margin-top: 20px;
    padding: 20px;
    background-color: #f9f9f9;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    text-align: right;
}

.checkout-btn {
    background-color: #3498db;
    color: #fff;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
}

.checkout-btn:hover {
    background-color: #2980b9;
}
.modal, .modal-1 {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
}

.modal-content, .modal-content-1 {
    background-color: #fff;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 40%;
    text-align: center;
    border-radius: 10px;
    position: relative;
}

.close, .close-1 {
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}


.my-button {
    width: 50px;
    height: 50px;
    background-color: #007bff;
    color: #fff;
    border: none;
    cursor: pointer;
    margin: 0 auto; /* Центрирование по горизонтали */
    display: block; /* Чтобы кнопка занимала всю доступную ширину */
}


</style>
{% endblock %}

{% block custom_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const removeButtons = document.querySelectorAll(".remove-btn");



    removeButtons.forEach(button => {
        button.addEventListener("click", function() {
            const size_element = document.querySelector(".size");
            const size = size_element.textContent[size_element.textContent.length-1]
            const productId = this.getAttribute("data-product-id")

            removeFromCart(productId, size)


        });
    });

    function removeFromCart(productId, productSize) {
        fetch(`/remove_from_cart/${productId}&${productSize}`)
            .then(response => response.json())
            .then(data => {
                const cartItem = document.querySelector(`[data-product-id="${productId}"]`).closest(".cart-item");
                const quantityElement = cartItem.querySelector(".quantity");
                ChangeData(quantityElement, data.quantity);
                if (data.quantity === "0") {
                    cartItem.remove();
                    const totalItems = document.querySelector(".total-items")
                    const totalItems_text = totalItems.textContent
                    totalItems.textContent = `Total Items: ${String(parseInt(totalItems_text[totalItems_text.length-1])-1)}`
                }
                updateTotalPrice()
            });
    }
    function ChangeData(quantityElement, quantity) {
        quantityElement.textContent = `Quantity: ${quantity}`;
    }

    function updateTotalPrice() {
    const totalPriceElement = document.querySelector(".total-price");
    const cartItems = document.querySelectorAll(".cart-item");
    let totalPrice = 0;

    cartItems.forEach(cartItem => {
        const priceElement = cartItem.querySelector(".price");
        const quantityElement = cartItem.querySelector(".quantity");
        const price = parseFloat(priceElement.textContent.split("$")[1]);
        const quantity = parseInt(quantityElement.textContent.split(":")[1]);
        totalPrice += price * quantity;
    });

    totalPriceElement.textContent = `Total Price: $${totalPrice.toFixed(2)}`;
}

});
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
    const CheckoutButton = document.querySelector(".checkout-btn");
    const modal = document.getElementById("myModal");
    const closeModal = document.querySelector(".close");
    const closeModal_1 = document.querySelector(".close-1")
    const goToPageButton = document.getElementById("goToPageButton");
    const goToPageButton_1 = document.getElementById("goToPageButton-1")
    const id_user = CheckoutButton.getAttribute("user-profile-id");
    const modal_1 = document.getElementById("myModal1")

        CheckoutButton.addEventListener("click", async function() {
            const id_user = this.getAttribute("user-profile-id")
            const totalPrice = document.querySelector(".total-price").textContent.split(":")[1];
            const TotalPrice = totalPrice.slice(2, totalPrice.length)
            const ans = await someFunction(id_user);
            console.log(ans)
            if (ans == true) {
                const response = await someFunction_1(TotalPrice);
                if (response == true) {
                    window.location.replace("/checkout");
                } else {
                    modal_1.style.display = "block";
                }
            }else{
                modal.style.display = "block";
            }
        });

        closeModal_1.addEventListener("click", function(){
            modal_1.style.display = "none";
        });

        closeModal.addEventListener("click", function() {
            modal.style.display = "none";
        });

        goToPageButton.addEventListener("click", function() {
            window.location.href = `/profile/${id_user}`;
        });

        goToPageButton_1.addEventListener("click", function() {
            modal_1.style.display = "none";
        });

    });

    function CheckDeliveryData(id_user) {
    return fetch(`/check_delivery_data/${id_user}`)
        .then(response => response.json())
        .then(data => {
            if (data.response == "full"){
                return true;
            } else {
                return false;
            }
        });
}

    function CheckTotalPrice(TotalPrice) {
        TotalPrice = Math.round(TotalPrice)
        return fetch(`/check_total_price/${TotalPrice}`)
            .then(response => response.json())
            .then(data => {
                if (data.response == "True"){
                    return true;
                } else {
                    return false;
                }
            });
    }

    async function someFunction(id_user) {
        try {
            const response = await CheckDeliveryData(id_user);
            return response;
        } catch (error) {
            console.error("Произошла ошибка:", error);
            return false;
        }
    }

    async function someFunction_1(total_price) {
        try {
            const response = await CheckTotalPrice(total_price);
            return response;
        } catch (error) {
            console.error("Произошла ошибка:", error);
            return false;
        }
    }

</script>
{% endblock %}